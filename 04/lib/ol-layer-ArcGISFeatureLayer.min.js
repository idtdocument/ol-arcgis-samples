(function(p,g){var q=ol.source.Vector,r=ol.layer.Vector,t=ol.format.EsriJSON,d=ol.style,l=d.Fill,h=d.Stroke,k=d.Style,u=ol.style.RegularShape,f={point:function(){return new k({image:new u({fill:new l({color:"orange"}),stroke:new h({color:"black",width:2}),points:5,radius:10,radius2:4,angle:0})})},polyline:function(){return new k({stroke:new h({color:"orange",width:1})})},polygon:function(){return new k({stroke:new h({color:"orange",lineDash:[4],width:3}),fill:new l({color:"rgba(255, 255, 255, 0.1)"})})}},
v=function(){},m=function(a){this.url=a};m.prototype={endpoint:function(a){return this.url+"/query?"+this._queryUri(a)},execute:function(a,b,c){a=this.endpoint(a);a=g.post(a);a.done(b);a.fail(c);return a},executeForFields:function(a,b){var c=g.post(this.url+"?f=json");c.done(a);c.fail(b);return c},_queryUri:function(a){var b="";for(key in a)b=key in this._uri?b+(key+"="+this._uri[key](a[key])+"&"):b+(key+"="+a[key]+"&");return b.slice(0,-1)},_uri:{geometry:function(a){return encodeURIComponent(JSON.stringify(a))},
outFields:function(a){return 1===a.length?a[0]:a.join(",")},outStatistics:function(a){return encodeURIComponent(JSON.stringify(a))},groupByFieldsForStatistics:function(a){return 1===a.length?a[0]:a.join(",")},objectIds:function(a){return 1===a.length?a[0]:a.join(",")},orderByFields:function(a){return 1===a.length?a[0]:a.join(",")}}};var e={point:"esriGeometryPoint",polyline:"esriGeometryPolyline",polygon:"esriGeometryPolygon",extent:"esriGeometryEnvelope",multipoint:"esriGeometryMultipoint"},w={intersect:"esriSpatialRelIntersects",
contain:"esriSpatialRelContains",crosse:"esriSpatialRelCrosses",envelopeIntersect:"esriSpatialRelEnvelopeIntersects",indexIntersect:"esriSpatialRelIndexIntersects",overlap:"esriSpatialRelOverlaps",touche:"esriSpatialRelTouches",within:"esriSpatialRelWithin"};ol2ArcGIS={extent:function(a,b){return{xmin:a[0],ymin:a[1],xmax:a[2],ymax:a[3],spatialReference:{wkid:b}}},map:{sr:function(a){return a.getView().getProjection().getCode().split(":")[1]}}};var n=function(a){throw a;};d=function(a,b){this.url=
a;this.map=b;this.geometryType=this.fields=this.source=null;this._loadLayerInfo();var c=new r({source:this._loadSource(this)});this.layer=c;this.layer.ext={name:null,geometryType:null,popTemplate:{title:null,attributes:null}};return c};d.prototype={_extPopAttributes:function(a){var b={};a.forEach(function(a){b[a.name]={title:a.alias}});return b},_loadLayerInfo:function(){g.post(this.url+"?f=pjson").then(function(a){a=JSON.parse(a);var b=this.layer.ext;b.name=a.name;b.geometryType=a.geometryType;b.popTemplate=
{title:a.name,attributes:this._extPopAttributes(a.fields)};b.geometryType===e.point&&this.layer.setStyle(f.point);b.geometryType===e.polyline&&this.layer.setStyle(f.polyline);b.geometryType===e.polygon&&this.layer.setStyle(f.polygon);b.geometryType===e.extent&&this.layer.setStyle(f.polygon)}.bind(this))},_defaultParams:function(a){var b=a.getView().calculateExtent();a=ol2ArcGIS.map.sr(a);var c=new v;c.geometry=ol2ArcGIS.extent(b,a);c.geometryType=e.extent;c.inSR=a;c.spatialRel=w.intersect;c.returnGeometry=
!0;c.outFields=["*"];c.outSR=a;c.f="json";return c},_loadSource:function(a){var b=new q({loader:function(){var b=a._defaultParams(a.map);(new m(a.url)).execute(b,a._addFeatures.bind(a),n)},strategy:function(a,b){this.resolution&&this.resolution!=b&&this.loadedExtentsRtree_.clear();return[a]}});return this.source=b},_addFeatures:function(a){a.error?n(a.error):(a=(new t).readFeatures(a,{featureProjection:ol2ArcGIS.map.sr(this.map)}),0<a.length&&this.source.addFeatures(a))}};p.ol.layer.ArcGISFeatureLayer=
d})(window,jQuery);